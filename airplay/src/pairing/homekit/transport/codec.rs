use std::{io, iter};

use bytes::{Buf, BufMut, Bytes, BytesMut};
use chacha20poly1305::{ChaCha20Poly1305, Key, KeyInit, Nonce, Tag, aead::AeadMutInPlace};
use tokio_util::codec::{Decoder, Encoder};

use crate::crypto::{self, HkdfOutput};

// 96-bit nonce
const NONCE_LEN: usize = 12;
// auth_tag len
const TAG_LEN: usize = 16;
// packet length size (2 bytes for number)
const PKT_SIZE_LEN: usize = 2;
// max payload size in 1 packet
const PAYLOAD_SIZE: usize = 1024;

pub struct HAPDecoder {
    pub key: HkdfOutput,
    pub count: u64,
}

impl HAPDecoder {
    pub fn new(shared_secret: impl AsRef<[u8]>) -> Self {
        const SALT: &[u8] = b"Control-Salt";
        const INFO: &[u8] = b"Control-Write-Encryption-Key";

        Self {
            key: crypto::hkdf(shared_secret.as_ref(), SALT, INFO),
            count: 0,
        }
    }
}

impl Decoder for HAPDecoder {
    type Item = Bytes;
    type Error = io::Error;

    fn decode(&mut self, src: &mut BytesMut) -> Result<Option<Self::Item>, Self::Error> {
        if src.len() < PKT_SIZE_LEN {
            src.reserve(PKT_SIZE_LEN);
            return Ok(None);
        }

        let len = src.get_u16_le();
        if len > PAYLOAD_SIZE as _ {
            return Err(io::Error::new(
                io::ErrorKind::OutOfMemory,
                format!("packet payload must not exceed {PAYLOAD_SIZE} bytes"),
            ));
        }

        let need = TAG_LEN + usize::from(len);
        if src.len() < need {
            src.reserve(need);
            return Ok(None);
        }

        let mut payload = src.split_to(len.into());
        let tag = src.split_to(TAG_LEN);
        let aad = len.to_le_bytes();
        let nonce = {
            let mut buf = [0u8; NONCE_LEN];
            let cnt_buf = self.count.to_le_bytes();
            buf[NONCE_LEN - cnt_buf.len()..].copy_from_slice(&cnt_buf);
            buf
        };

        let mut cipher = ChaCha20Poly1305::new(Key::from_slice(&self.key));
        cipher
            .decrypt_in_place_detached(
                Nonce::from_slice(&nonce),
                &aad,
                &mut payload,
                Tag::from_slice(&tag),
            )
            .map_err(|_| io::Error::new(io::ErrorKind::InvalidInput, "income decryption failed"))?;

        self.count += 1;

        Ok(Some(payload.freeze()))
    }
}

pub struct HAPEncoder {
    key: HkdfOutput,
    count: usize,
}

impl HAPEncoder {
    pub fn new(shared_secret: impl AsRef<[u8]>) -> Self {
        const SALT: &[u8] = b"Control-Salt";
        const INFO: &[u8] = b"Control-Read-Encryption-Key";

        Self {
            key: crypto::hkdf(shared_secret.as_ref(), SALT, INFO),
            count: 0,
        }
    }
}

impl<T: AsRef<[u8]>> Encoder<T> for HAPEncoder {
    type Error = io::Error;

    fn encode(&mut self, item: T, dst: &mut BytesMut) -> Result<(), Self::Error> {
        let item = item.as_ref();
        let (chunks, left) = item.as_chunks::<{ PAYLOAD_SIZE }>();
        let blocks = chunks
            .iter()
            .map(<[_; _]>::as_slice)
            .chain(iter::once(left));
        let len = blocks
            .clone()
            .map(|bytes| PKT_SIZE_LEN + bytes.len() + TAG_LEN)
            .sum::<usize>();
        dst.reserve(len);

        for b in blocks {
            let len = b.len();
            let mut cipher = ChaCha20Poly1305::new(Key::from_slice(&self.key));
            let aad = (len as u16).to_le_bytes();
            let nonce = {
                let mut buf = [0u8; NONCE_LEN];
                let cnt_buf = self.count.to_le_bytes();
                buf[NONCE_LEN - cnt_buf.len()..].copy_from_slice(&cnt_buf);
                buf
            };
            let mut databuf = {
                let mut buf = [0u8; PAYLOAD_SIZE];
                buf[..len].copy_from_slice(b);
                buf
            };
            let data = &mut databuf[..len];
            let tag = cipher
                .encrypt_in_place_detached(Nonce::from_slice(&nonce), &aad, data)
                .map_err(|_| io::Error::other("can't encode data"))?;

            dst.put_slice(&aad);
            dst.put_slice(data);
            dst.put_slice(&tag);

            self.count += 1;
        }

        Ok(())
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    const SHARED_SECRET: &[u8] = b"01234567890123456789012345678901";

    #[test]
    fn test_small_encryption() {
        const INPUT: &[u8] = b"hello world";
        const OUTPUT: &[u8] = &[
            11, 0, 161, 216, 132, 85, 150, 136, 137, 47, 50, 222, 49, 90, 117, 21, 87, 135, 17, 21,
            189, 51, 135, 94, 215, 141, 85, 236, 99,
        ];

        let mut encoder = HAPEncoder::new(SHARED_SECRET);
        let mut output = BytesMut::new();
        encoder.encode(INPUT, &mut output).unwrap();

        assert_eq!(output, OUTPUT);
    }

    #[test]
    fn test_large_encryption() {
        const INPUT: &[u8] = &[b'A'; 1124];
        const OUTPUT: &[u8] = &[
            0, 4, 136, 252, 169, 120, 184, 233, 191, 1, 1, 243, 20, 240, 22, 37, 158, 99, 53, 200,
            148, 246, 125, 60, 54, 84, 240, 9, 165, 100, 230, 178, 204, 161, 0, 133, 187, 236, 93,
            216, 217, 167, 77, 158, 198, 72, 211, 138, 79, 25, 91, 74, 240, 88, 201, 82, 8, 36,
            117, 44, 245, 117, 11, 140, 99, 80, 233, 136, 64, 206, 84, 106, 216, 21, 161, 171, 177,
            187, 86, 109, 40, 70, 194, 19, 176, 222, 92, 51, 123, 195, 6, 235, 121, 254, 151, 245,
            20, 104, 189, 5, 185, 191, 194, 123, 78, 192, 248, 124, 134, 159, 32, 138, 223, 158,
            199, 145, 211, 228, 40, 216, 16, 152, 98, 126, 234, 121, 3, 94, 103, 199, 28, 79, 143,
            230, 163, 59, 112, 74, 200, 160, 10, 115, 221, 78, 166, 194, 167, 98, 131, 34, 202, 99,
            120, 28, 173, 96, 123, 99, 64, 190, 9, 170, 252, 206, 113, 122, 218, 117, 116, 243, 49,
            141, 76, 229, 82, 74, 31, 193, 155, 51, 39, 253, 24, 128, 141, 26, 23, 138, 75, 252, 2,
            72, 186, 217, 175, 217, 58, 153, 23, 43, 83, 2, 185, 103, 136, 179, 10, 134, 92, 173,
            107, 65, 76, 139, 72, 111, 225, 167, 135, 181, 157, 226, 229, 186, 245, 45, 172, 57,
            134, 143, 242, 214, 74, 81, 157, 235, 52, 71, 227, 212, 34, 251, 181, 141, 18, 177, 74,
            151, 229, 207, 208, 206, 12, 78, 208, 18, 55, 252, 215, 76, 13, 98, 215, 54, 220, 192,
            188, 199, 45, 1, 224, 57, 39, 44, 125, 88, 200, 231, 246, 135, 26, 236, 244, 102, 205,
            204, 112, 209, 141, 150, 112, 20, 186, 249, 64, 77, 82, 148, 210, 14, 248, 10, 162,
            233, 147, 50, 185, 242, 177, 152, 167, 91, 186, 135, 204, 203, 122, 181, 67, 231, 255,
            14, 232, 110, 41, 0, 32, 224, 127, 211, 177, 57, 143, 104, 114, 16, 229, 218, 42, 62,
            189, 137, 55, 75, 55, 70, 27, 140, 43, 20, 52, 3, 77, 3, 233, 137, 240, 161, 9, 184,
            235, 49, 218, 136, 106, 194, 102, 87, 210, 200, 41, 254, 247, 92, 252, 6, 92, 229, 99,
            12, 215, 213, 58, 81, 67, 89, 43, 63, 173, 108, 72, 96, 139, 25, 231, 179, 189, 39,
            210, 95, 230, 115, 110, 44, 209, 193, 252, 191, 134, 193, 127, 200, 45, 203, 116, 235,
            197, 113, 5, 164, 52, 150, 180, 180, 89, 225, 127, 156, 156, 210, 26, 151, 66, 173, 85,
            64, 189, 53, 27, 35, 190, 220, 135, 206, 41, 226, 195, 231, 201, 9, 96, 253, 145, 250,
            245, 133, 120, 38, 221, 238, 246, 20, 117, 108, 177, 49, 64, 119, 69, 221, 50, 82, 187,
            199, 247, 146, 174, 253, 152, 134, 139, 140, 102, 36, 188, 150, 103, 79, 84, 136, 108,
            123, 89, 9, 145, 188, 13, 9, 39, 196, 85, 15, 210, 217, 185, 201, 92, 177, 240, 226,
            24, 215, 8, 103, 237, 37, 53, 187, 114, 8, 123, 22, 197, 187, 195, 65, 158, 113, 193,
            111, 59, 88, 128, 178, 207, 254, 149, 172, 87, 210, 110, 20, 127, 113, 249, 94, 113,
            76, 1, 152, 170, 15, 83, 5, 177, 232, 53, 203, 2, 193, 96, 176, 231, 28, 59, 40, 142,
            126, 7, 114, 213, 161, 254, 156, 22, 42, 24, 81, 162, 60, 24, 1, 226, 218, 173, 115,
            38, 118, 167, 90, 2, 29, 31, 24, 183, 240, 197, 9, 151, 146, 2, 255, 142, 241, 173, 55,
            194, 156, 135, 160, 212, 115, 100, 234, 39, 33, 186, 242, 30, 1, 228, 249, 240, 206,
            16, 81, 92, 217, 11, 213, 58, 17, 42, 121, 162, 29, 102, 177, 57, 175, 104, 249, 242,
            115, 187, 43, 141, 224, 232, 180, 8, 16, 17, 183, 231, 43, 37, 211, 137, 139, 7, 119,
            17, 213, 45, 46, 194, 135, 240, 59, 30, 83, 42, 237, 12, 206, 218, 150, 80, 74, 112,
            132, 178, 217, 35, 27, 41, 226, 223, 85, 193, 29, 68, 178, 33, 192, 25, 158, 255, 3,
            188, 149, 15, 188, 43, 170, 81, 28, 108, 197, 246, 69, 199, 151, 117, 229, 173, 253,
            166, 139, 37, 137, 193, 75, 111, 224, 25, 201, 134, 89, 164, 6, 62, 176, 189, 33, 84,
            242, 51, 232, 231, 184, 217, 218, 55, 16, 142, 137, 149, 176, 202, 16, 39, 182, 109,
            177, 198, 232, 245, 167, 216, 169, 219, 50, 109, 225, 208, 225, 63, 172, 70, 20, 134,
            40, 147, 75, 57, 226, 28, 225, 249, 182, 183, 110, 12, 150, 154, 109, 124, 125, 119,
            123, 29, 100, 122, 98, 79, 55, 203, 19, 90, 93, 93, 152, 76, 67, 43, 110, 53, 247, 198,
            85, 94, 100, 149, 28, 128, 47, 103, 38, 220, 122, 101, 165, 127, 148, 235, 217, 229,
            144, 108, 212, 144, 77, 41, 167, 73, 185, 145, 253, 16, 86, 66, 49, 212, 156, 156, 63,
            198, 180, 27, 26, 73, 182, 96, 208, 252, 71, 47, 220, 230, 216, 53, 63, 160, 244, 115,
            82, 203, 134, 240, 44, 86, 227, 194, 6, 82, 70, 54, 20, 28, 224, 17, 58, 118, 105, 41,
            171, 187, 6, 241, 116, 204, 114, 188, 241, 93, 231, 127, 151, 151, 142, 40, 183, 185,
            90, 55, 208, 39, 30, 93, 228, 185, 89, 61, 30, 14, 118, 29, 120, 101, 59, 23, 175, 130,
            195, 61, 126, 255, 219, 172, 88, 97, 107, 30, 128, 253, 230, 16, 116, 170, 90, 97, 197,
            186, 5, 195, 230, 156, 166, 89, 4, 7, 3, 147, 137, 63, 46, 55, 217, 182, 154, 166, 134,
            203, 105, 164, 202, 79, 247, 202, 68, 38, 73, 228, 151, 161, 254, 102, 222, 79, 170,
            162, 129, 126, 72, 227, 141, 233, 153, 27, 242, 110, 204, 28, 69, 178, 16, 19, 85, 112,
            109, 147, 198, 113, 61, 28, 207, 147, 115, 178, 129, 124, 227, 43, 27, 72, 1, 120, 246,
            143, 36, 180, 191, 245, 226, 222, 91, 131, 204, 228, 159, 243, 41, 8, 253, 72, 67, 27,
            210, 179, 134, 100, 0, 36, 144, 48, 66, 83, 158, 20, 236, 161, 58, 149, 216, 87, 172,
            116, 34, 222, 97, 20, 209, 185, 116, 198, 142, 117, 103, 120, 97, 180, 160, 103, 12,
            72, 0, 207, 62, 88, 140, 129, 54, 176, 176, 188, 53, 223, 33, 127, 118, 102, 54, 41,
            185, 91, 22, 69, 131, 80, 220, 216, 53, 12, 210, 33, 14, 62, 198, 230, 186, 169, 63,
            78, 44, 189, 122, 243, 244, 173, 129, 187, 127, 207, 13, 141, 152, 101, 187, 202, 35,
            12, 61, 85, 220, 110, 23, 123, 154, 175, 148, 191, 86, 215, 146, 13, 148, 188, 47, 83,
            28, 29, 27, 102, 62, 253, 132, 62, 98,
        ];

        let mut encoder = HAPEncoder::new(SHARED_SECRET);
        let mut output = BytesMut::new();
        encoder.encode(INPUT, &mut output).unwrap();

        assert_eq!(output, OUTPUT);
    }

    #[test]
    fn test_small_decryption() {
        const INPUT: &[u8] = &[
            11, 0, 97, 76, 199, 144, 195, 153, 246, 203, 69, 186, 243, 167, 16, 174, 213, 254, 57,
            235, 95, 168, 93, 111, 103, 183, 26, 10, 55,
        ];
        const OUTPUT: &[u8] = b"hello world";

        let mut decoder = HAPDecoder::new(SHARED_SECRET);
        let output = decoder.decode(&mut INPUT.into()).unwrap().unwrap();

        assert_eq!(output, OUTPUT);
    }

    #[test]
    fn test_large_decryption() {
        const INPUT: &[u8] = &[
            0, 4, 72, 104, 234, 189, 237, 248, 192, 229, 118, 151, 214, 74, 238, 51, 211, 110, 247,
            237, 18, 84, 208, 185, 245, 39, 214, 14, 151, 103, 123, 2, 200, 192, 216, 217, 211, 86,
            250, 121, 139, 43, 85, 215, 173, 104, 226, 93, 184, 59, 219, 184, 41, 169, 187, 109,
            241, 173, 196, 228, 7, 149, 35, 12, 104, 145, 30, 190, 33, 26, 39, 31, 108, 208, 8,
            251, 188, 221, 58, 183, 45, 105, 200, 183, 215, 192, 182, 190, 12, 89, 70, 37, 181, 86,
            168, 109, 153, 178, 242, 63, 138, 35, 203, 194, 1, 38, 125, 45, 98, 131, 211, 62, 173,
            188, 112, 34, 97, 98, 221, 253, 104, 66, 173, 52, 133, 38, 134, 70, 180, 171, 1, 37, 4,
            133, 74, 37, 193, 247, 236, 240, 166, 85, 94, 224, 168, 106, 108, 86, 43, 225, 148, 11,
            35, 137, 23, 49, 101, 247, 252, 209, 192, 54, 219, 55, 6, 242, 186, 90, 9, 242, 129,
            83, 189, 144, 164, 143, 174, 78, 22, 213, 73, 112, 42, 17, 47, 28, 208, 92, 90, 85, 67,
            16, 66, 136, 2, 124, 155, 26, 175, 137, 36, 147, 19, 56, 120, 181, 129, 127, 155, 0,
            139, 214, 21, 173, 31, 214, 67, 243, 147, 80, 69, 85, 208, 151, 229, 62, 134, 79, 206,
            117, 97, 194, 71, 96, 165, 206, 239, 68, 59, 176, 252, 215, 197, 53, 201, 38, 115, 184,
            7, 130, 235, 73, 136, 84, 153, 30, 220, 13, 55, 175, 59, 4, 141, 242, 31, 166, 223,
            184, 115, 31, 245, 130, 83, 199, 249, 145, 43, 26, 153, 74, 120, 144, 190, 141, 71,
            203, 25, 132, 161, 9, 148, 235, 35, 155, 215, 32, 86, 34, 233, 86, 17, 121, 123, 138,
            136, 253, 36, 218, 207, 170, 150, 12, 236, 5, 11, 70, 38, 182, 156, 239, 146, 229, 166,
            56, 11, 176, 227, 178, 253, 142, 138, 251, 151, 134, 0, 189, 32, 12, 26, 173, 59, 78,
            253, 243, 1, 4, 28, 7, 216, 11, 44, 22, 239, 190, 72, 238, 60, 116, 29, 32, 33, 168,
            56, 134, 99, 98, 239, 216, 240, 48, 172, 193, 254, 177, 182, 42, 51, 245, 85, 87, 106,
            222, 254, 105, 54, 200, 206, 173, 5, 112, 168, 30, 108, 44, 238, 254, 31, 17, 95, 18,
            165, 228, 38, 226, 164, 75, 157, 49, 175, 28, 19, 153, 233, 247, 1, 242, 89, 28, 184,
            51, 188, 243, 202, 112, 171, 86, 181, 113, 53, 233, 33, 91, 118, 137, 8, 64, 148, 85,
            147, 150, 122, 162, 90, 142, 10, 150, 101, 29, 122, 182, 23, 87, 120, 56, 178, 108,
            232, 217, 234, 73, 180, 228, 196, 29, 227, 185, 152, 248, 84, 34, 185, 43, 198, 28,
            255, 137, 168, 136, 191, 28, 201, 161, 214, 156, 90, 202, 190, 72, 104, 190, 44, 62,
            66, 186, 110, 30, 153, 177, 183, 35, 219, 248, 159, 107, 134, 193, 52, 164, 69, 204,
            15, 78, 1, 61, 0, 209, 205, 135, 55, 120, 25, 12, 247, 15, 26, 146, 25, 230, 60, 80,
            235, 79, 25, 5, 87, 217, 56, 29, 176, 128, 12, 64, 241, 217, 41, 136, 154, 52, 97, 217,
            111, 46, 113, 169, 233, 97, 50, 51, 229, 146, 0, 69, 226, 131, 169, 187, 40, 183, 95,
            118, 15, 39, 126, 65, 126, 56, 206, 31, 112, 28, 18, 147, 145, 137, 232, 11, 13, 129,
            35, 134, 183, 132, 154, 132, 147, 66, 205, 149, 133, 97, 136, 114, 153, 81, 114, 52,
            239, 241, 38, 92, 217, 170, 165, 21, 32, 209, 65, 121, 12, 92, 43, 99, 253, 250, 95,
            198, 124, 104, 170, 186, 155, 17, 150, 78, 53, 144, 154, 0, 144, 30, 240, 226, 116,
            235, 8, 74, 20, 82, 129, 196, 181, 179, 25, 30, 153, 160, 36, 119, 221, 52, 3, 97, 174,
            231, 156, 230, 96, 194, 112, 213, 37, 133, 52, 203, 129, 20, 111, 1, 162, 252, 170, 69,
            89, 144, 7, 37, 106, 136, 56, 9, 75, 222, 168, 201, 1, 100, 35, 145, 106, 169, 136, 55,
            13, 7, 5, 66, 100, 148, 48, 102, 217, 137, 128, 102, 235, 210, 242, 91, 144, 171, 212,
            46, 97, 237, 32, 2, 158, 250, 134, 25, 159, 174, 188, 156, 255, 170, 238, 39, 231, 49,
            152, 230, 184, 93, 78, 159, 214, 166, 196, 48, 136, 3, 251, 49, 254, 251, 166, 255,
            253, 7, 198, 109, 107, 123, 181, 161, 122, 11, 203, 235, 109, 127, 232, 100, 126, 98,
            78, 160, 199, 216, 28, 38, 25, 238, 160, 47, 213, 22, 17, 102, 203, 172, 173, 120, 75,
            110, 249, 62, 84, 27, 19, 120, 59, 101, 30, 137, 115, 103, 92, 233, 184, 13, 195, 79,
            209, 187, 140, 170, 134, 126, 101, 112, 9, 146, 54, 9, 233, 254, 84, 114, 23, 208, 59,
            162, 225, 136, 100, 193, 223, 213, 50, 170, 25, 137, 183, 207, 234, 147, 219, 15, 201,
            175, 189, 239, 121, 194, 31, 229, 167, 70, 156, 58, 169, 143, 145, 118, 9, 173, 232,
            133, 1, 103, 94, 159, 219, 60, 179, 208, 119, 122, 109, 81, 36, 131, 58, 79, 159, 8,
            165, 216, 172, 139, 148, 172, 14, 120, 69, 166, 21, 182, 18, 144, 76, 11, 134, 44, 63,
            235, 164, 116, 8, 165, 167, 213, 148, 131, 83, 163, 93, 215, 26, 45, 93, 239, 77, 99,
            205, 123, 59, 237, 203, 13, 198, 186, 251, 150, 164, 37, 75, 20, 15, 147, 134, 70, 198,
            254, 81, 243, 86, 61, 177, 246, 197, 154, 218, 209, 181, 199, 210, 155, 248, 91, 25,
            234, 1, 106, 198, 84, 43, 61, 144, 26, 81, 243, 46, 175, 235, 43, 232, 122, 106, 85,
            65, 9, 23, 147, 230, 226, 168, 242, 40, 249, 211, 18, 244, 167, 161, 222, 199, 93, 58,
            78, 154, 234, 126, 64, 163, 186, 102, 215, 188, 111, 201, 68, 164, 78, 142, 168, 13,
            70, 85, 137, 26, 199, 187, 216, 51, 136, 38, 102, 17, 77, 175, 125, 159, 25, 253, 35,
            52, 132, 90, 127, 44, 1, 157, 25, 209, 234, 105, 155, 91, 194, 207, 152, 149, 54, 16,
            165, 40, 196, 27, 189, 118, 176, 202, 140, 127, 141, 27, 51, 14, 82, 184, 142, 172, 22,
            127, 51, 239, 192, 207, 55, 237, 51, 132, 236, 8, 228, 111, 216, 61, 192, 233, 160,
            207, 133, 30, 169, 100, 83, 161, 48, 222, 224, 136, 169, 210, 145, 89, 229, 155, 184,
            170, 175, 201, 41, 81, 76, 188, 54, 6, 120, 124, 164, 196, 9, 166, 154, 190, 128, 187,
            133, 227, 89, 162, 228, 118, 119, 165, 119, 225, 216, 127, 194, 242, 233, 173, 11, 42,
            30, 153, 84, 124, 162, 245, 219, 103, 220, 97, 60, 222, 36, 147, 154, 188, 235, 20, 95,
            90, 189, 222, 110, 207, 33, 134, 43, 199, 221, 86, 120, 180, 49, 113, 80, 158, 43, 175,
            49, 139, 18, 114, 79, 227, 133, 2, 22, 161, 112, 169, 127, 16, 189, 57, 174, 229, 207,
            14, 16, 21, 129, 81, 82, 194, 250, 122, 91, 62, 213, 157, 60, 128, 17, 21, 86, 116,
            180, 44, 104, 171, 18, 253, 170, 193, 74, 205, 111, 241, 134, 70, 65, 253, 236, 104,
            116, 216, 55, 191, 171, 94, 244, 118, 93, 245, 11, 163, 231, 120, 58, 92, 232, 140,
            248, 194, 180, 80, 12, 169, 238, 123, 37, 153, 235, 85, 81, 191, 21, 225, 72, 8, 18,
            154, 237, 236, 53, 2, 20, 161, 92, 126, 228, 238, 52, 148, 217, 61, 212, 17, 70, 101,
            70, 238, 188, 186, 222, 241, 189, 96, 62, 94, 240, 183, 198, 237, 83, 60, 214, 72, 241,
            1, 131, 16, 153, 6, 118, 44, 16, 121, 150, 202, 185, 8, 17, 218, 22, 56, 10, 207, 76,
            58, 239, 236, 207, 138, 244, 10, 194, 24, 47, 78, 86, 162, 228, 236, 116, 174, 180,
            218, 235, 38, 143,
        ];
        const OUTPUT1: &[u8] = &[b'A'; 1024];
        const OUTPUT2: &[u8] = &[b'A'; 300];

        let mut decoder = HAPDecoder::new(SHARED_SECRET);
        let mut input = INPUT.into();

        let output1 = decoder.decode(&mut input).unwrap().unwrap();
        assert_eq!(output1, OUTPUT1);

        let output2 = decoder.decode(&mut input).unwrap().unwrap();
        assert_eq!(output2, OUTPUT2);
    }
}
